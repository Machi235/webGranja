{% extends "base.html" %}

{% block titulo %}Editar Dieta{% endblock %}

{% block contenido %}
<div class="container my-4">
    <div class="card shadow p-4" style="border-radius: 20px;">
        <h2 class="text-center mb-4">Editar Dieta</h2>

        <form id="formEditarDieta" method="POST" action="{{ url_for('dietas.editar_dieta', idDieta=dieta.idDieta) }}">
            <!-- Selección de Especie -->
            <div class="mb-3">
                <label for="idEspecie" class="form-label"><strong>Especie*</strong></label>
                <select id="idEspecie" name="idEspecie" class="form-select" required>
                    <option value="">-- Seleccionar especie --</option>
                    {% for especie in especies %}
                        <option value="{{ especie.idEspecie }}" 
                        {% if dieta.idEspecie == especie.idEspecie %}selected{% endif %}>
                            {{ especie.tipoEspecie }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Descripción -->
            <div class="mb-3">
                <label for="descripcion" class="form-label"><strong>Descripción*</strong></label>
                <input type="text" id="descripcion" name="descripcion" class="form-control" value="{{ dieta.tipoDieta }}" required>
            </div>

            <!-- Definitivo -->
            <div class="mb-3 form-check">
                <input type="checkbox" id="definitivo" name="definitivo" value="1" class="form-check-input"
                {% if dieta.definitivo == 1 %}checked{% endif %}>
                <label for="definitivo" class="form-check-label">¿Definitivo?</label>
            </div>

            <!-- Alimentos -->
            <h4 class="mt-4">Alimentos de la Dieta</h4>
            <div id="contenedorAlimentos"></div>
            <button type="button" class="btn btn-secondary mt-2" id="btnAgregar">+ Agregar alimento</button>

            <br><br>
            <button type="submit" id="btnGuardarDieta" class="btn btn-success w-100">Guardar cambios</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
let alimentosDisponibles = {{ alimentosDisponibles | tojson | safe }};
let alimentosIniciales = {{ alimentos | tojson | safe }};

// ---------- Función para crear fila ----------
function agregarFila(alimento = null) {
    const contenedor = document.getElementById('contenedorAlimentos');
    const fila = document.createElement('div');
    fila.className = 'fila-alimento mb-2 d-flex gap-2 align-items-start';

    // Select
    const select = document.createElement('select');
    select.name = 'idAlimento[]';
    select.className = 'form-select alimento-select';
    select.required = true;
    select.style.minWidth = '220px';

    alimentosDisponibles.forEach(al => {
        const opt = document.createElement('option');
        opt.value = al.idAlimento;
        opt.textContent = al.nombre;
        select.appendChild(opt);
    });

    if (alimento) select.value = alimento.idAlimento;

    // Cantidad
    const cantidad = document.createElement('input');
    cantidad.name = 'cantidadAlimento[]';
    cantidad.placeholder = 'Cantidad';
    cantidad.className = 'form-control';
    cantidad.required = true;
    cantidad.value = alimento ? alimento.cantidadAlimento : '';

    // Frecuencia
    const frecuencia = document.createElement('input');
    frecuencia.name = 'frecuenciaAlimento[]';
    frecuencia.placeholder = 'Frecuencia';
    frecuencia.className = 'form-control';
    frecuencia.required = true;
    frecuencia.value = alimento ? alimento.frecuenciaAlimento : '';

    // Botón eliminar
    const btnEliminar = document.createElement('button');
    btnEliminar.type = 'button';
    btnEliminar.className = 'btn btn-danger';
    btnEliminar.textContent = 'Eliminar';
    btnEliminar.onclick = () => fila.remove();

    fila.appendChild(select);
    fila.appendChild(cantidad);
    fila.appendChild(frecuencia);
    fila.appendChild(btnEliminar);

    contenedor.appendChild(fila);
}

// ---------- Cargar filas iniciales ----------
window.addEventListener('load', () => {
    if (alimentosIniciales.length > 0) {
        alimentosIniciales.forEach(a => agregarFila(a));
    } else {
        agregarFila();
    }
});

// ---------- Botón agregar fila ----------
document.getElementById('btnAgregar').addEventListener('click', () => {
    if (alimentosDisponibles.length === 0) {
        Swal.fire('Atención', 'No hay alimentos disponibles para esta especie.', 'info');
        return;
    }
    agregarFila();
});

// ---------- Guardar cambios ----------
document.getElementById("formEditarDieta").addEventListener("submit", function(e){
    e.preventDefault();
    const form = e.target;
    const btn = document.getElementById('btnGuardarDieta');
    btn.disabled = true;
    btn.textContent = 'Guardando...';

    fetch(form.action, {
        method: "POST",
        body: new FormData(form)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Éxito', 'La dieta se actualizó correctamente.', 'success')
            .then(() => window.location.href = "{{ url_for('dietas.ver_dietas') }}");
        } else {
            Swal.fire('Error', data.error || 'No se pudo guardar la dieta.', 'error');
        }
    })
    .catch(() => Swal.fire('Error', 'Ocurrió un error al guardar la dieta.', 'error'))
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Guardar cambios';
    });
});
</script>
{% endblock %}
