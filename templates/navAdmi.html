<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&family=Delius&family=Sour+Gummy:wght@400;700&display=swap" rel="stylesheet">

  <!-- Estilos personalizados -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <title>Panel Admin</title>
</head>

<body>
  <nav class="navbar fixed-top">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar">
          <span class="navbar-toggler-icon"></span>
        </button>
            <a class="navbar-brand d-flex align-items-center" href="#">
        <img class="logo" src="{{ url_for('static', filename='img/logo.png') }}" 
             alt="Logo Granja Machis"  class="me-2">
        <span class="titulo-2">Granja Livestock Log</span>
      </a>

      <div class="accesos">
        <button class="crearNotificacion" id="crearNotificacion" data-bs-toggle="modal" data-bs-target="#modalNotificacion">
          <i class="bi bi-send-plus"></i>
        </button>
        <button class="btn btn-outline-primary position-relative" id="btnNotificaciones"
                data-bs-toggle="modal" data-bs-target="#modalNotificaciones">
          <i class="bi bi-bell-fill"></i>
          {% if notificaciones_no_leidas > 0 %}
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            {{ notificaciones_no_leidas }}
          </span>
          {% endif %}
        </button>
      </div> 

        


      <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title">Men√∫</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>

        <div class="offcanvas-body">
          <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
            <li><a class="nav-link" href="{{ url_for('animales.registro_animal') }}">Crear Animal</a></li>
            <li><a class="nav-link" href="{{ url_for('habitat_bp.crear_habitat') }}">Crear H√°bitats</a></li>
            <li><a class="nav-link" href="{{ url_for('turnos_bp.horarios') }}">Turnos</a></li>
            <li><a class="nav-link" href="{{ url_for('animales.ver_animales') }}">Ver Animales</a></li>
            <li><a class="nav-link" href="{{ url_for('auth.ver_usuarios') }}">Ver Usuarios</a></li>
            <li><a class="nav-link" href="{{ url_for('habitat_bp.ver_habitats') }}">Ver H√°bitats</a></li>
            <li><a class="nav-link" href="{{ url_for('eventos.registro_cirugia') }}">Cirug√≠a</a></li>
            <li><a class="nav-link" href="{{ url_for('eventos.registro_medicacion') }}">Medicaci√≥n</a></li>
            <li><a class="nav-link" href="{{ url_for('eventos.registro_postoperatorio') }}">Postoperatorio</a></li>
            <li><a class="nav-link" href="{{ url_for('eventos.registro_terapia') }}">Terapia F√≠sica</a></li>
            <li><a class="nav-link" href="{{ url_for('eventos.registro_vacuna') }}">Vacunas</a></li>
            <li><a class="nav-link" href="{{ url_for('eventos.registro_visita') }}">Visita</a></li>
            <li><a class="nav-link" href="{{ url_for('actividad_bp.ver_actividades') }}">Ver Actividad</a></li>
            <li><a class="nav-link" href="{{ url_for('auth.registro') }}">Registro</a></li>
            <li><a class="nav-link" href="{{ url_for('tareas.listar_tareas') }}">Tareas</a></li>
            <li><a class="nav-link text-danger" href="{{ url_for('auth.logout') }}">
              <i class="bi bi-box-arrow-right"></i> Cerrar Sesi√≥n
            </a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

<!--Modal Notificaci√≥n -->
<div class="modal fade" id="modalNotificacion" tabindex="-1" aria-labelledby="modalNotificacionLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header text-white">
        <h5 class="modal-title" id="modalNotificacionLabel">Enviar Notificaci√≥n</h5>
      </div>
      <div class="modal-body">

        <div class="mb-3">
          <label for="rol" class="form-label">Seleccionar Rol</label>
          <select id="rol" class="form-select">
            <option value="">-- Cargando roles... --</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="usuario" class="form-label">Seleccionar Usuario</label>
          <select id="usuario" class="form-select" disabled>
            <option value="">-- Primero escoge un rol --</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="titulo" class="form-label">T√≠tulo</label>
          <input type="text" id="titulo" class="form-control" placeholder="Asunto de la notificaci√≥n">
        </div>

        <div class="mb-3">
          <label for="descripcion" class="form-label">Descripci√≥n</label>
          <textarea id="descripcion" class="form-control" rows="3" placeholder="Mensaje..."></textarea>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" id="enviar">Enviar</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Modal de √©xito -->
<div class="modal fade" id="modalExito" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title w-100">¬°Notificaci√≥n enviada!</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
        <p class="mt-3 mb-0">La notificaci√≥n fue enviada correctamente al usuario seleccionado.</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Cargar roles
  $('#modalNotificacion').on('show.bs.modal', function() {
    fetch('/roles_notificacion')
      .then(res => res.json())
      .then(data => {
        let options = '<option value="">-- Escoge un rol --</option>';
        data.forEach(r => options += `<option value="${r.rol}">${r.rol}</option>`);
        $('#rol').html(options);
      });
  });

  // Cargar usuarios seg√∫n rol
  $('#rol').change(function() {
    const rol = $(this).val();
    if (!rol) {
      $('#usuario').prop('disabled', true).html('<option>-- Primero escoge un rol --</option>');
      return;
    }
    fetch(`/usuarios_por_rol/${rol}`)
      .then(res => res.json())
      .then(data => {
        let options = '<option value="">-- Escoge un usuario --</option>';
        data.forEach(u => options += `<option value="${u.idUsuario}">${u.nombre} ${u.apellido}</option>`);
        $('#usuario').html(options).prop('disabled', false);
      });
  });

  // Enviar notificaci√≥n
  $('#enviar').click(function() {
    const datos = {
      titulo: $('#titulo').val(),
      descripcion: $('#descripcion').val(),
      rol: $('#rol').val(),
      idUsuario: $('#usuario').val()  // clave: idUsuario
    };

    if (!datos.titulo || !datos.descripcion || !datos.rol || !datos.idUsuario) {
      alert('Por favor completa todos los campos.');
      return;
    }

    console.log("Datos a enviar:", datos);  // DEBUG

    fetch('/guardar_notificacion', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(datos)
    })
    .then(res => res.json())
    .then(data => {
      console.log("Respuesta del servidor:", data); // DEBUG
      if (data.success) {
        $('#modalNotificacion').modal('hide');
        $('#modalNotificacion').one('hidden.bs.modal', function () {
          $('.modal-backdrop').remove();
          $('body').removeClass('modal-open');
          $('#titulo, #descripcion').val('');
          $('#rol').val('');
          $('#usuario').html('<option>-- Primero escoge un rol --</option>').prop('disabled', true);
          const modalExito = new bootstrap.Modal(document.getElementById('modalExito'));
          modalExito.show();
          setTimeout(() => modalExito.hide(), 2000);
        });
      } else {
        alert('‚ùå Error al enviar la notificaci√≥n: ' + data.error);
      }
    });
  });
</script>

<!-- MODAL DE NOTIFICACIONES (igual que RRHH) -->
<div class="modal fade" id="modalNotificaciones" tabindex="-1" aria-labelledby="modalNotificacionesLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header text-white">
        <h5 class="modal-title" id="modalNotificacionesLabel">Notificaciones Recibidas</h5>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs" id="tabsNoti" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="nuevas-tab" data-bs-toggle="tab" data-bs-target="#nuevas"
                    type="button" role="tab">Nuevas</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial"
                    type="button" role="tab">Historial</button>
          </li>
        </ul>
        <div class="tab-content mt-2">

          <!-- Nuevas -->
          <div class="tab-pane fade show active" id="nuevas" role="tabpanel">
            {% set nuevas = notificaciones|selectattr("leida","equalto",False)|list %}
            {% if nuevas %}
              {% for n in nuevas %}
                <div class="card mb-2" id="notificacion-{{ n.id }}">
                  <div class="card-body d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="card-title">{{ n.titulo }}</h6>
                      <p class="card-text">{{ n.descripcion }}</p>
                      <small class="text-muted">üìÖ {{ n.fecha.strftime("%d/%m/%Y %H:%M") }}</small>
                    </div>
                    <button class="btn btn-sm btn-success ms-2 btn-leido" data-id="{{ n.id }}">
                      <i class="bi bi-check2"></i>
                    </button>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-center text-muted">No tienes notificaciones nuevas.</p>
            {% endif %}
          </div>

          <!-- Historial -->
          <div class="tab-pane fade" id="historial" role="tabpanel">
            {% set leidas = notificaciones|selectattr("leida","equalto",True)|list %}
            {% if leidas %}
              {% for n in leidas %}
                <div class="card mb-2">
                  <div class="card-body">
                    <h6 class="card-title">{{ n.titulo }}</h6>
                    <p class="card-text">{{ n.descripcion }}</p>
                    <small class="text-muted">üìÖ {{ n.fecha.strftime("%d/%m/%Y %H:%M") }}</small>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-center text-muted">No hay historial de notificaciones.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('click', function(e) {
  if(e.target.closest('.btn-leido')) {
    const btn = e.target.closest('.btn-leido');
    const id = btn.dataset.id;

    fetch(`/marcar_notificacion/${id}`, {
      method: 'POST'
    })
    .then(res => res.json())
    .then(data => {
      if(data.success) {
        const card = document.getElementById(`notificacion-${id}`);
        if(card) card.remove();
      }
    });
  }
});
</script>


</body>
</html>
