<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- bootstrap css y js -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    <!-- google fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&family=Delius&family=Sour+Gummy:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
     <!-- Iconos de bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <!-- estilo ccs -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/verAnimal.css') }}">
    <title>Turnos</title>
</head>
  <body>
     {% include "navAHome.html" %}
<div class="container py-4">
  <h1 class="mb-4">Dietas Registradas</h1>

  <!-- FILTROS: solo por especie (el filtro por animal se eliminó porque ya no lo usamos) -->
  <form class="row mb-4" method="get" action="{{ url_for('dietas.ver_dietas') }}">
    <div class="col-md-8">
      <select name="idEspecie" class="form-select">
        <option value="">Filtrar por Especie</option>
        {% for especie in especies %}
        <option value="{{ especie.idEspecie }}"
          {% if filtro_idEspecie and filtro_idEspecie == especie.idEspecie %}selected{% endif %}>
          {{ especie.tipoEspecie }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <button class="btn btn-primary w-100" type="submit">Aplicar Filtro</button>
    </div>
  </form>

  <!-- LISTADO DE DIETAS -->
  <div class="row">
    {% for dieta in dietas %}
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">{{ dieta.tipoDieta }} <small class="text-muted">({{ dieta.tipoEspecie }})</small></h5>
          <p class="mb-1"><strong>Registrada:</strong> {{ dieta.fechaRegistro }}</p>

          <span class="badge {% if dieta.definitivo == 1 %}bg-success{% else %}bg-warning text-dark{% endif %}">
            {% if dieta.definitivo == 1 %}Definitiva{% else %}Provisional{% endif %}
          </span>

          <hr>
          <h6>Alimentos</h6>

          {% if dieta.alimentos and dieta.alimentos|length > 0 %}
            <ul class="list-group">
              {% for al in dieta.alimentos %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ al.nombreAlimento }}</strong>
                  <div class="small text-muted">{{ al.cantidadAlimento }} — {{ al.frecuenciaAlimento }}</div>
                </div>
                <!-- Dentro de card-body, debajo de la lista de alimentos -->
                <!-- Si más adelante quieres botón eliminar por alimento: -->
                <!-- <button class="btn btn-danger btn-sm" onclick="eliminarAlimento({{ dieta.idDieta }}, {{ al.idAlimento }})">X</button> -->
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">No hay alimentos registrados para esta dieta.</p>
          {% endif %}
          <div class="mt-3 d-flex gap-2">
                  <a href="{{ url_for('dietas.editar_dieta', idDieta=dieta.idDieta) }}" class="btn btn-warning btn-sm">Editar</a>
                  <button class="btn btn-danger btn-sm" onclick="eliminarDieta('{{ dieta.idDieta }}')">Eliminar</button>
                  <a href="{{ url_for('dietas.generar_pdf', idDieta=dieta.idDieta) }}" class="btn btn-warning btn-sm"> Imprimir </a>
                </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if dietas|length == 0 %}
    <div class="alert alert-warning text-center">No se encontraron dietas.</div>
  {% endif %}
</div>
<!-- PAGINACIÓN -->
{% if total_paginas > 1 %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">

        <!-- Botón anterior -->
        <li class="page-item {% if pagina == 1 %}disabled{% endif %}">
            <a class="page-link"
               href="{{ url_for('dietas.ver_dietas', idEspecie=filtro_idEspecie, page=pagina-1) }}">
               &laquo; Anterior
            </a>
        </li>

        <!-- Números -->
        {% for p in range(1, total_paginas + 1) %}
            <li class="page-item {% if p == pagina %}active{% endif %}">
                <a class="page-link"
                   href="{{ url_for('dietas.ver_dietas', idEspecie=filtro_idEspecie, page=p) }}">
                   {{ p }}
                </a>
            </li>
        {% endfor %}

        <!-- Botón siguiente -->
        <li class="page-item {% if pagina == total_paginas %}disabled{% endif %}">
            <a class="page-link"
               href="{{ url_for('dietas.ver_dietas', idEspecie=filtro_idEspecie, page=pagina+1) }}">
               Siguiente &raquo;
            </a>
        </li>

    </ul>
</nav>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function eliminarDieta(idDieta) {
    idDieta = parseInt(idDieta); // convertir a número por seguridad
    Swal.fire({
        title: '¿Eliminar dieta?',
        text: "Esta acción no se puede deshacer",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/dietas/eliminar_dieta/${idDieta}`, {
                method: "POST",
                headers: {'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'}
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Eliminada', 'La dieta ha sido eliminada.', 'success')
                    .then(() => location.reload());
                } else {
                    Swal.fire('Error', data.error || 'No se pudo eliminar.', 'error');
                }
            })
            .catch(() => Swal.fire('Error', 'Ocurrió un error al eliminar.', 'error'));
        }
    });
}
</script>
   
  </body>
</html>