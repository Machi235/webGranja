{% extends "base.html" %}

{% block contenido %}
{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/verAnimal.css') }}">
{% endblock %}

<div class="container py-4">
  <h1 class="mb-4">Dietas Registradas</h1>

  <!-- FILTROS: solo por especie (el filtro por animal se eliminó porque ya no lo usamos) -->
  <form class="row mb-4" method="get" action="{{ url_for('dietas.ver_dietas') }}">
    <div class="col-md-8">
      <select name="idEspecie" class="form-select">
        <option value="">Filtrar por Especie</option>
        {% for especie in especies %}
        <option value="{{ especie.idEspecie }}"
          {% if filtro_idEspecie and filtro_idEspecie == especie.idEspecie %}selected{% endif %}>
          {{ especie.tipoEspecie }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <button class="btn btn-primary w-100" type="submit">Aplicar Filtro</button>
    </div>
  </form>

  <!-- LISTADO DE DIETAS -->
  <div class="row">
    {% for dieta in dietas %}
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">{{ dieta.tipoDieta }} <small class="text-muted">({{ dieta.tipoEspecie }})</small></h5>
          <p class="mb-1"><strong>Registrada:</strong> {{ dieta.fechaRegistro }}</p>

          <span class="badge {% if dieta.definitivo == 1 %}bg-success{% else %}bg-warning text-dark{% endif %}">
            {% if dieta.definitivo == 1 %}Definitiva{% else %}Provisional{% endif %}
          </span>

          <hr>
          <h6>Alimentos</h6>

          {% if dieta.alimentos and dieta.alimentos|length > 0 %}
            <ul class="list-group">
              {% for al in dieta.alimentos %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ al.nombreAlimento }}</strong>
                  <div class="small text-muted">{{ al.cantidadAlimento }} — {{ al.frecuenciaAlimento }}</div>
                </div>
                <!-- Dentro de card-body, debajo de la lista de alimentos -->
                <!-- Si más adelante quieres botón eliminar por alimento: -->
                <!-- <button class="btn btn-danger btn-sm" onclick="eliminarAlimento({{ dieta.idDieta }}, {{ al.idAlimento }})">X</button> -->
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">No hay alimentos registrados para esta dieta.</p>
          {% endif %}
          <div class="mt-3 d-flex gap-2">
                  <a href="{{ url_for('dietas.editar_dieta', idDieta=dieta.idDieta) }}" class="btn btn-warning btn-sm">Editar</a>
                  <button class="btn btn-danger btn-sm" onclick="eliminarDieta('{{ dieta.idDieta }}')">Eliminar</button>
                </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if dietas|length == 0 %}
    <div class="alert alert-warning text-center">No se encontraron dietas.</div>
  {% endif %}
</div>
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function eliminarDieta(idDieta) {
    idDieta = parseInt(idDieta); // convertir a número por seguridad
    Swal.fire({
        title: '¿Eliminar dieta?',
        text: "Esta acción no se puede deshacer",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/dietas/eliminar_dieta/${idDieta}`, {
                method: "POST",
                headers: {'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'}
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Eliminada', 'La dieta ha sido eliminada.', 'success')
                    .then(() => location.reload());
                } else {
                    Swal.fire('Error', data.error || 'No se pudo eliminar.', 'error');
                }
            })
            .catch(() => Swal.fire('Error', 'Ocurrió un error al eliminar.', 'error'));
        }
    });
}
</script>
{% endblock %}

{% endblock %}
