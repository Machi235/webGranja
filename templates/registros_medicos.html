<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial Cl√≠nico - Animal {{ id_animal }}</title>

    <!-- Bootstrap y SweetAlert -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Fuentes y CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/registros_medicos.css') }}">
</head>
<body>

<!-- HEADER -->
<div class="header-section">
    <div class="container">
        <div class="header-content">
            <div class="header-title">
                <h1 style="margin: 0; font-size: 2rem; font-weight: 700;">Historial Cl√≠nico</h1>
            </div>
            <a href="{{ url_for('animales.ver_animal', idAnimal=id_animal) }}" class="btn-back">
                <i class="bi bi-arrow-left"></i> Volver a la ficha
            </a>
        </div>
    </div>
</div>

<!-- CONTENIDO -->
<div class="container mb-5">
    <!-- FILTROS -->
    <div class="filter-card">
        <form method="POST" action="{{ url_for('reporte.reportes', id_animal=id_animal) }}" class="row g-3">
            <div class="col-md-5">
                <label class="form-label">Tipo de evento</label>
                <select name="tipo" class="form-select">
                    <option value="">Todos los tipos</option>
                    <option value="Vacuna">Vacuna</option>
                    <option value="Medicaci√≥n">Medicaci√≥n</option>
                    <option value="Cirug√≠a">Cirug√≠a</option>
                    <option value="Postoperatorio">Postoperatorio</option>
                    <option value="Terapia F√≠sica">Terapia F√≠sica</option>
                    <option value="Visita">Visita</option>
                </select>
            </div>
            <div class="col-md-5">
                <label class="form-label">Fecha espec√≠fica</label>
                <input type="date" name="fecha" class="form-control">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn-filter w-100">
                    <i class="bi bi-search"></i> Buscar
                </button>
            </div>
        </form>
    </div>

    <!-- LISTA DE REGISTROS -->
    {% if registros %}
        <div class="row g-4">
            {% for r in registros %}
                <div class="col-md-6 col-lg-4">
                    <div class="record-card">
                        <div class="card-header-custom">
                            <h5>
                                <i class="bi bi-{{ 
                                    'shield-plus' if r.tipo == 'Vacuna' else 
                                    'prescription2' if r.tipo == 'Medicaci√≥n' else 
                                    'bandaid' if r.tipo == 'Cirug√≠a' else 
                                    'heart-pulse' if r.tipo == 'Postoperatorio' else 
                                    'activity' if r.tipo == 'Terapia F√≠sica' else 
                                    'calendar-check' 
                                }}"></i>
                                {{ r.tipo }}
                            </h5>
                        </div>
                        <div class="card-body-custom">
                            <div class="info-row">
                                <span class="info-label">Fecha:</span>
                                <span class="info-value">{{ r.fecha or 'Sin fecha' }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Detalle:</span>
                                <span class="info-value">{{ r.descripcion }}</span>
                            </div>

                            <!-- üîπ Acciones -->
                            <div class="btn-actions">
                                <a href="{{ url_for('reporte.detalle_reporte', id_registro=r.id_registro) }}" 
                                   class="btn-modern btn-view">
                                    <i class="bi bi-eye"></i> Ver detalle
                                </a>

                                <a href="{{ url_for('reporte.editar_reporte', id_registro=r.id_registro) }}" 
                                   class="btn-modern btn-edit">
                                    <i class="bi bi-pencil"></i> Editar
                                </a>

                                <form id="form-eliminar-{{ r.id_registro }}" 
                                      method="POST" 
                                      action="{{ url_for('reporte.eliminar_reporte') }}">
                                    <input type="hidden" name="id_registro" value="{{ r.id_registro }}">
                                    <input type="hidden" name="tipo" value="{{ r.tipo }}">
                                    <input type="hidden" name="id_animal" value="{{ id_animal }}"> <!-- ‚úÖ fijo -->

                                    <button type="button" 
                                            class="btn-modern btn-delete w-100"
                                            onclick="confirmarEliminacion({{ r.id_registro }}, '{{ r.tipo }}', '{{ r.fecha }}')">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state text-center">
            <div class="empty-icon">
                <i class="bi bi-inbox"></i>
            </div>
            <h4>No hay registros cl√≠nicos</h4>
            <p>Este animal a√∫n no tiene eventos m√©dicos registrados en el sistema.</p>
            <a href="{{ url_for('animales.ver_animal', idAnimal=id_animal) }}" class="btn-add">
                <i class="bi bi-plus-circle"></i> Agregar primer evento
            </a>
        </div>
    {% endif %}
</div>

<!-- FLASH MESSAGES -->
{% with mensajes = get_flashed_messages(with_categories=true) %}
    {% if mensajes %}
        <script>
            {% for categoria, mensaje in mensajes %}
                Swal.fire({
                    icon: '{{ "success" if categoria == "success" else "warning" if categoria == "warning" else "error" }}',
                    title: '{{ "¬°√âxito!" if categoria == "success" else "Atenci√≥n" if categoria == "warning" else "Error" }}',
                    text: '{{ mensaje }}',
                    timer: 3000,
                    showConfirmButton: true,
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#4a7c2c'
                });
            {% endfor %}
        </script>
    {% endif %}
{% endwith %}

<!-- CONFIRMACI√ìN ELIMINACI√ìN -->
<script>
function confirmarEliminacion(id, tipo, fecha) {
    Swal.fire({
        title: '¬øEliminar este registro?',
        html: `
            <div style="text-align: left; background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin: 1rem 0;">
                <p><strong>Tipo:</strong> ${tipo}</p>
                <p><strong>Fecha:</strong> ${fecha || 'Sin fecha'}</p>
            </div>
            <p style="color: #d32f2f; font-weight: 600;">‚ö†Ô∏è Esta acci√≥n no se puede deshacer</p>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="bi bi-trash"></i> S√≠, eliminar',
        cancelButtonText: '<i class="bi bi-x-circle"></i> Cancelar',
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Eliminando...',
                text: 'Por favor espera...',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => Swal.showLoading()
            });
            document.getElementById(`form-eliminar-${id}`).submit();
        }
    });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
