{% extends 'base.html' %}

{% block titulo %}Crear Dieta{% endblock %}

{% block contenido %}
<h2>Crear Dieta</h2>

<form id="formCrearDieta" method="POST" action="{{ url_for('dietas.crear_dieta') }}">
    <!-- Selección de Animal -->
    <div class="mb-3">
        <label for="idAnimal" class="form-label">Animal:</label>
        <select id="idAnimal" name="idAnimal" class="form-select" required onchange="cargarAlimentos()">
            <option value="">-- Seleccionar --</option>
            {% for animal in animales %}
                <option value="{{ animal.idAnimal }}">{{ animal.nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Tipo de Dieta -->
    <div class="mb-3">
        <label for="tipoDieta" class="form-label">Tipo de Dieta:</label>
        <input type="text" id="tipoDieta" name="tipoDieta" class="form-control" placeholder="Ejemplo: Balanceada, Proteica..." required>
    </div>

    <!-- Definitivo -->
    <div class="mb-3 form-check">
        <input type="checkbox" id="definitivo" name="definitivo" value="1" class="form-check-input">
        <label for="definitivo" class="form-check-label">¿Definitivo?</label>
    </div>

    <!-- Alimentos de la Dieta -->
    <h3>Alimentos</h3>
    <div id="contenedorAlimentos"></div>
    <button type="button" class="btn btn-secondary mt-2" onclick="agregarFila()">+ Agregar alimento</button>

    <br><br>
    <button type="submit" id="btnGuardarDieta" class="btn btn-primary">Guardar Dieta</button>
</form>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
let alimentosDisponibles = [];

function cargarAlimentos() {
    const idAnimal = document.getElementById('idAnimal').value;
    if (!idAnimal) return;

    fetch(`/dietas/alimentos_por_animal/${idAnimal}`)
        .then(res => res.json())
        .then(data => {
            alimentosDisponibles = data;
            document.querySelectorAll('.alimento-select').forEach(select => {
                select.innerHTML = '<option value="">Seleccione un alimento</option>';
                data.forEach(alimento => {
                    const opt = document.createElement('option');
                    opt.value = alimento.idAlimento;
                    opt.textContent = alimento.Origen;
                    select.appendChild(opt);
                });
            });
        })
        .catch(err => console.error('Error cargando alimentos:', err));
}

function agregarFila() {
    const contenedor = document.getElementById('contenedorAlimentos');
    const fila = document.createElement('div');
    fila.className = 'fila-alimento mb-2 d-flex gap-2';

    const select = document.createElement('select');
    select.name = 'idAlimento[]';
    select.className = 'form-select alimento-select';
    select.required = true;
    select.innerHTML = '<option value="">Seleccione un alimento</option>';
    alimentosDisponibles.forEach(alimento => {
        const opt = document.createElement('option');
        opt.value = alimento.idAlimento;
        opt.textContent = alimento.Origen;
        select.appendChild(opt);
    });

    const cantidad = document.createElement('input');
    cantidad.name = 'cantidadAlimento[]';
    cantidad.placeholder = 'Cantidad';
    cantidad.className = 'form-control';
    cantidad.required = true;

    const frecuencia = document.createElement('input');
    frecuencia.name = 'frecuenciaAlimento[]';
    frecuencia.placeholder = 'Frecuencia';
    frecuencia.className = 'form-control';
    frecuencia.required = true;

    const btnEliminar = document.createElement('button');
    btnEliminar.type = 'button';
    btnEliminar.className = 'btn btn-danger';
    btnEliminar.textContent = 'Eliminar';
    btnEliminar.onclick = () => eliminarFila(btnEliminar);

    fila.appendChild(select);
    fila.appendChild(cantidad);
    fila.appendChild(frecuencia);
    fila.appendChild(btnEliminar);

    contenedor.appendChild(fila);
}

function eliminarFila(btn) {
    btn.parentElement.remove();
}

document.getElementById("formCrearDieta").addEventListener("submit", function(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    fetch(form.action, { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                title: '¡Éxito!',
                text: 'La dieta se ha creado correctamente.',
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: 'Ver Dietas',
                cancelButtonText: 'Cerrar'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "{{ url_for('dietas.ver_dietas') }}";
                }
            });
            form.reset();
            document.getElementById('contenedorAlimentos').innerHTML = '';
        } else if (data.error) {
            Swal.fire('Error', data.error, 'error');
        }
    })
    .catch(err => {
        console.error(err);
        Swal.fire('Error', 'Ocurrió un error inesperado.', 'error');
    });
});

window.onload = () => agregarFila();
</script>
{% endblock %}
