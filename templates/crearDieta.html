{% extends "base.html" %}

{% block titulo %}Crear Dieta{% endblock %}

{% block contenido %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/verAnimal.css') }}">
{% endblock %}

<div class="container my-4">
    <div class="card shadow p-4" style="border-radius: 20px;">
        <h2 class="text-center mb-4">Crear Dieta</h2>

        <form id="formCrearDieta" method="POST" action="{{ url_for('dietas.crear_dieta') }}">

            <!-- Selección de Especie -->
            <div class="mb-3">
                <label for="idEspecie" class="form-label"><strong>Especie*</strong></label>
                <select id="idEspecie" name="idEspecie" class="form-select" required onchange="cargarAlimentos()">
                    <option value="">-- Seleccionar especie --</option>
                    {% for especie in especies %}
                        <option value="{{ especie.idEspecie }}">{{ especie.tipoEspecie }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Descripción -->
            <div class="mb-3">
                <label for="descripcion" class="form-label"><strong>Descripción*</strong></label>
                <input type="text" id="descripcion" name="descripcion" class="form-control" required>
            </div>

            <!-- Definitivo -->
            <div class="mb-3 form-check">
                <input type="checkbox" id="definitivo" name="definitivo" value="1" class="form-check-input">
                <label for="definitivo" class="form-check-label">¿Definitivo?</label>
            </div>

            <!-- Alimentos -->
            <h4 class="mt-4">Alimentos de la Dieta</h4>
            <div id="contenedorAlimentos"></div>
            <button type="button" class="btn btn-secondary mt-2" id="btnAgregar">+ Agregar alimento</button>

            <br><br>
            <button type="submit" id="btnGuardarDieta" class="btn btn-success w-100">Guardar</button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
let alimentosDisponibles = [];

// ---------- Cargar alimentos ----------
function cargarAlimentos() {
    const idEspecie = document.getElementById('idEspecie').value;
    document.getElementById('contenedorAlimentos').innerHTML = '';
    
    if (!idEspecie) {
        alimentosDisponibles = [];
        return;
    }

    fetch(`/dietas/alimentos_por_especie/${idEspecie}`)
        .then(res => res.json())
        .then(data => {
            if (!data.success) throw new Error("Backend devolvió error");
            alimentosDisponibles = data.alimentos || [];
            document.querySelectorAll('.alimento-select').forEach(select => actualizarOpciones(select));
        })
        .catch(err => {
            console.error(err);
            Swal.fire('Error', 'No se pudieron cargar los alimentos para la especie seleccionada.', 'error');
        });
}

// ---------- Actualizar opciones ----------
function actualizarOpciones(select) {
    select.innerHTML = '<option value="">Seleccione un alimento</option>';
    alimentosDisponibles.forEach(al => {
        const opt = document.createElement('option');
        opt.value = al.idAlimento;
        opt.textContent = al.Origen;
        select.appendChild(opt);
    });
}

// ---------- Agregar fila ----------
function agregarFila() {
    const contenedor = document.getElementById('contenedorAlimentos');
    const fila = document.createElement('div');
    fila.className = 'fila-alimento mb-2 d-flex gap-2 align-items-start';

    const select = document.createElement('select');
    select.name = 'idAlimento[]';
    select.className = 'form-select alimento-select';
    select.required = true;
    select.style.minWidth = '220px';
    actualizarOpciones(select);

    const cantidad = document.createElement('input');
    cantidad.name = 'cantidadAlimento[]';
    cantidad.placeholder = 'Cantidad';
    cantidad.className = 'form-control';
    cantidad.required = true;

    const frecuencia = document.createElement('input');
    frecuencia.name = 'frecuenciaAlimento[]';
    frecuencia.placeholder = 'Frecuencia';
    frecuencia.className = 'form-control';
    frecuencia.required = true;

    const btnEliminar = document.createElement('button');
    btnEliminar.type = 'button';
    btnEliminar.className = 'btn btn-danger';
    btnEliminar.textContent = 'Eliminar';
    btnEliminar.onclick = () => fila.remove();

    fila.appendChild(select);
    fila.appendChild(cantidad);
    fila.appendChild(frecuencia);
    fila.appendChild(btnEliminar);

    contenedor.appendChild(fila);
}

// ---------- LOAD ----------
window.addEventListener('load', agregarFila);

// ---------- Agregar alimento ----------
document.getElementById('btnAgregar').addEventListener('click', () => {
    if (alimentosDisponibles.length === 0) {
        Swal.fire('Atención', 'Selecciona primero una especie para cargar sus alimentos.', 'info');
        return;
    }
    agregarFila();
});

// ---------- Enviar dieta ----------
document.getElementById("formCrearDieta").addEventListener("submit", function(e) {
    e.preventDefault();
    const form = e.target;
    const btn = document.getElementById('btnGuardarDieta');

    btn.disabled = true;
    btn.textContent = 'Guardando...';

    fetch(form.action, {
        method: "POST",
        body: new FormData(form)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                title: 'Éxito',
                text: 'La dieta se creó correctamente.',
                icon: 'success',
                confirmButtonText: 'Ir a Dietas'
            }).then(() => {
                window.location.href = "{{ url_for('dietas.ver_dietas') }}";
            });
        } else {
            Swal.fire('Error', data.error || 'No se pudo guardar la dieta.', 'error');
        }
    })
    .catch(() => {
        Swal.fire('Error', 'Ocurrió un error al guardar.', 'error');
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Guardar';
    });
});
</script>
{% endblock %}
